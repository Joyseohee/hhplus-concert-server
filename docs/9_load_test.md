---

# STEP 19 – 대기열 부하 테스트 계획서 (RDB vs Redis vs Kafka)

> **대상**: 대기열(Queue) 기능 성능 측정
> **목적**: 구현 방식(RDB, Redis, Kafka)에 따른 성능 비교 및 병목 지점 식별

---

## 1. 목적

* **처리 용량(Capacity)**: 대기열 진입 요청이 안정적으로 처리 가능한 최대 RPS/VU 산출
* **지연 시간(Latency)**: `/queue/token` 응답 시간 분포(p50/p90/p95/p99 및 최대값) 측정
* **오류율(Reliability)**: HTTP 실패율, 4xx/5xx 비중 파악
* **자원 사용량(Efficiency)**: CPU, 메모리, 커넥션 풀, GC, 네트워크 I/O 지표 수집
* **병목 식별(Bottleneck)**:

  * RDB: 트랜잭션 락 및 인덱스 경합
  * Redis: 키 경쟁 및 TTL 처리 지연
  * Kafka: 메시지 생산·소비 지연
* **비교 평가(Trade-off)**: 단순성 vs 성능/확장성 vs 운영 복잡도를 고려한 선택 기준 확보

---

## 2. 범위

* **SUT(Service Under Test)**: Spring Boot 기반 `concert` 서버 (JDK 21)
* **테스트 대상 엔드포인트**

  * `POST /queue/token` : 대기열 진입 토큰 발급
* **비교 구현 방식** (비즈니스 로직 및 응답 스키마 동일 유지)

  * **RDB**: 트랜잭션/락 기반 동시성 제어
  * **Redis**: Sorted Set 기반 동시성 제어
  * **Kafka**: 카프카로 순차 입장

---

## 3. 시나리오 설계

* **부하 패턴**: `ramping-vus` (점진 증가 → 피크 유지 → 점진 감소)
* **프로파일**

  * 0 → 200 VU, 30s 램프업
  * 200 → 800 VU, 1m 램프업
  * 800 VU 유지 30s
  * 800 → 0 VU, 1m 램프다운
* **가상 유저 시퀀스 (queueFlow)**

  1. `POST /queue/token` 요청
  2. 응답 상태코드(200) 및 스키마(필수 필드 존재) 검증

---

## 4. 데이터 준비

* 테스트 전 초기 데이터 세팅 및 상태 초기화 수행

---

## 5. 측정 지표 및 목표

* **k6 (클라이언트 관점)**

  * `http_req_duration{api:queue}`: p90 < 300ms, p95 < 500ms, max < 2000ms
  * `http_req_failed{api:queue}`: rate < 1%

---

## 6. 관측 환경

* **DB/Redis/Kafka 모니터링 대시보드** 구성
* 피크 구간의 `p95` 및 오류율을 k6 지표와 병렬 비교

---

## 7. k6 스크립트 (초안)

```js
// (동일 – 생략)
```

---

## 8. 공정성 원칙

* 동일 인프라 환경에서 모드별 테스트 수행
* 각 실행 전 캐시/버퍼 초기화
* 동일한 트래픽 패턴 및 요청 분포 적용

---

## 9. 분석 계획

* 모드별 주요 지표(`p95`, 실패율, RPS)를 표로 비교
* 병목 원인 및 개선 포인트 도출

---

## 10. 예시 결과

| 모드    |       p95 | max |   med | min |   avg |  실패율 | 최대 동시성 |
| ----- |----------:| --: | ----: | --: | ----: | ---: | -----: |
| RDB   |       11s | 21s |    3s | 1ms |    4s | 0.0% |    800 |
| Redis |     873ms |  1s | 569ms | 1ms | 550ms | 0.0% |    800 |
| Kafka |        1s |  1s | 666ms | 1ms | 630ms | 0.0% |    800 |

* **주요 관찰**:

  * RDB 모드는 락 경합으로 인한 심각한 지연 발생
  * Redis 모드는 안정적인 성능 개선 효과 확인
  * Kafka는 설정·운영 복잡도 대비 성능 개선 효과 미미

* **결론**: 대기열 처리에는 **Redis** 사용이 가장 적절
